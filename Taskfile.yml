version: '3'

vars:
  PLUGINS_DIR: plugins
  COLLECTIONS_DIR: collections

tasks:
  default:
    desc: List available tasks
    cmds:
      - task --list

  # =============================================================================
  # Development
  # =============================================================================

  list:plugins:
    desc: List all plugins
    cmds:
      - ls -1 {{.PLUGINS_DIR}}

  list:collections:
    desc: List all collections
    cmds:
      - ls -1 {{.COLLECTIONS_DIR}}

  # =============================================================================
  # Clipboard helpers (for deploying to Thymer)
  # =============================================================================

  copy:plugin:
    desc: Copy a plugin to clipboard (usage - task copy:plugin -- github)
    cmds:
      - cat {{.PLUGINS_DIR}}/{{.CLI_ARGS}}/plugin.js | wl-copy
      - echo "Copied {{.CLI_ARGS}}/plugin.js to clipboard"

  copy:collection:
    desc: Copy a collection schema to clipboard (usage - task copy:collection -- issues)
    cmds:
      - cat {{.COLLECTIONS_DIR}}/{{.CLI_ARGS}}/collection.json | wl-copy
      - echo "Copied {{.CLI_ARGS}}/collection.json to clipboard"

  copy:synchub:
    desc: Copy Sync Hub plugin to clipboard
    cmds:
      - cat synchub/plugin.js | wl-copy
      - echo "Copied synchub/plugin.js to clipboard"

  copy:synchub:collection:
    desc: Copy Sync Hub collection schema to clipboard
    cmds:
      - cat synchub/collection.json | wl-copy
      - echo "Copied synchub/collection.json to clipboard"

  # =============================================================================
  # File paths (when clipboard doesn't work)
  # =============================================================================

  path:plugin:
    desc: Print plugin file path (usage - task path:plugin -- github)
    cmds:
      - realpath {{.PLUGINS_DIR}}/{{.CLI_ARGS}}/plugin.js

  path:collection:
    desc: Print collection schema path (usage - task path:collection -- issues)
    cmds:
      - realpath {{.COLLECTIONS_DIR}}/{{.CLI_ARGS}}/collection.json

  # =============================================================================
  # New plugin scaffolding
  # =============================================================================

  new:plugin:
    desc: Create a new plugin from template (usage - task new:plugin -- my-plugin)
    cmds:
      - cp -r {{.PLUGINS_DIR}}/_template {{.PLUGINS_DIR}}/{{.CLI_ARGS}}
      - echo "Created {{.PLUGINS_DIR}}/{{.CLI_ARGS}}/"
      - echo "Edit plugin.js and plugin.json to customize"

  new:collection:
    desc: Create a new collection (usage - task new:collection -- my-collection)
    cmds:
      - mkdir -p {{.COLLECTIONS_DIR}}/{{.CLI_ARGS}}
      - |
        cat > {{.COLLECTIONS_DIR}}/{{.CLI_ARGS}}/collection.json << 'EOF'
        {
          "ver": 1,
          "name": "{{.CLI_ARGS}}",
          "icon": "ti-folder",
          "home": false,
          "page_field_ids": [],
          "item_name": "Item",
          "description": "Description here",
          "show_sidebar_items": true,
          "show_cmdpal_items": true,
          "fields": [
            {
              "icon": "ti-id",
              "id": "external_id",
              "label": "External ID",
              "type": "text",
              "read_only": true,
              "active": true
            }
          ],
          "sidebar_record_sort_dir": "desc",
          "sidebar_record_sort_field_id": "created_at",
          "managed": {"fields": false, "views": false, "sidebar": false},
          "custom": {},
          "views": []
        }
        EOF
      - echo "Created {{.COLLECTIONS_DIR}}/{{.CLI_ARGS}}/collection.json"

  # =============================================================================
  # Git shortcuts
  # =============================================================================

  status:
    desc: Git status
    cmds:
      - git status

  diff:
    desc: Git diff
    cmds:
      - git diff

  push:
    desc: Git push
    cmds:
      - git push

  # =============================================================================
  # Documentation
  # =============================================================================

  docs:
    desc: Show plugin creation guide
    cmds:
      - cat CREATING_PLUGINS.md

  # =============================================================================
  # Validation
  # =============================================================================

  validate:json:
    desc: Validate all collection.json files
    cmds:
      - |
        for f in {{.COLLECTIONS_DIR}}/*/collection.json synchub/collection.json; do
          echo "Validating $f..."
          python3 -m json.tool "$f" > /dev/null && echo "  ‚úì Valid" || echo "  ‚úó Invalid"
        done

  validate:plugins:
    desc: Check plugin.json files exist and are valid
    cmds:
      - |
        for d in {{.PLUGINS_DIR}}/*/; do
          name=$(basename "$d")
          if [ "$name" = "_template" ]; then continue; fi

          if [ -f "$d/plugin.json" ]; then
            echo "‚úì $name/plugin.json exists"
            python3 -m json.tool "$d/plugin.json" > /dev/null || echo "  ‚úó Invalid JSON"
          else
            echo "‚úó $name/plugin.json missing"
          fi

          if [ -f "$d/plugin.js" ]; then
            echo "‚úì $name/plugin.js exists"
          else
            echo "‚úó $name/plugin.js missing"
          fi
        done

  # =============================================================================
  # Release Management
  # =============================================================================

  release:
    desc: Create a release (usage - task release -- v1.2.0)
    silent: true
    cmds:
      - |
        VERSION="{{.CLI_ARGS}}"
        if [ -z "$VERSION" ]; then
          echo "Usage: task release -- v1.2.0"
          exit 1
        fi

        # Validate version format
        if ! echo "$VERSION" | grep -qE '^v[0-9]+\.[0-9]+\.[0-9]+$'; then
          echo "Error: Version must be in format v1.2.3"
          exit 1
        fi

        echo "üöÄ Creating release $VERSION"
        echo ""

        # 1. Update VERSION file
        echo "$VERSION" > VERSION
        echo "‚úì Updated VERSION file"

        # 2. Update version in all plugin .js files
        echo "‚úì Updating version in plugin files..."

        # Find all plugin.js files and add/update version constant
        for f in synchub/plugin.js \
                 agenthub/plugin.js \
                 habithub/plugin.js \
                 {{.COLLECTIONS_DIR}}/*/plugin.js \
                 {{.PLUGINS_DIR}}/*/plugin.js; do
          if [ -f "$f" ] && ! echo "$f" | grep -q "_template"; then
            # Check if VERSION constant exists, update or add it
            if grep -q "^const VERSION = " "$f"; then
              sed -i "s/^const VERSION = .*/const VERSION = '$VERSION';/" "$f"
            else
              # Add after 'use strict' or at top
              if grep -q "'use strict'" "$f"; then
                sed -i "/'use strict'/a const VERSION = '$VERSION';" "$f"
              else
                sed -i "1i const VERSION = '$VERSION';" "$f"
              fi
            fi
            echo "  ‚úì $f"
          fi
        done

        # 3. Git commit
        echo ""
        git add -A
        git commit -m "Release $VERSION"
        echo "‚úì Committed changes"

        # 4. Git tag
        git tag "$VERSION"
        echo "‚úì Created tag $VERSION"

        # 5. Push
        git push origin master --tags
        echo "‚úì Pushed to origin"

        # 6. Create zip bundle
        ZIPNAME="thymer-synchub-$VERSION.zip"
        echo ""
        echo "üì¶ Creating $ZIPNAME..."

        zip -r "$ZIPNAME" \
          VERSION \
          synchub/ \
          agenthub/ \
          habithub/ \
          {{.COLLECTIONS_DIR}}/ \
          {{.PLUGINS_DIR}}/ \
          -x "*.git*" \
          -x "*/_template/*" \
          -x "*/node_modules/*"

        echo "‚úì Created $ZIPNAME"

        # 7. Create GitHub release
        echo ""
        echo "üì¢ Creating GitHub release..."
        gh release create "$VERSION" "$ZIPNAME" \
          --title "$VERSION" \
          --generate-notes

        echo ""
        echo "‚úÖ Release $VERSION complete!"
        echo "   https://github.com/riclib/thymer-synchub/releases/tag/$VERSION"

        # Cleanup
        rm "$ZIPNAME"

  release:dry-run:
    desc: Preview what release would do (usage - task release:dry-run -- v1.2.0)
    silent: true
    cmds:
      - |
        VERSION="{{.CLI_ARGS}}"
        if [ -z "$VERSION" ]; then
          echo "Usage: task release:dry-run -- v1.2.0"
          exit 1
        fi

        echo "üîç Dry run for release $VERSION"
        echo ""
        echo "Would update VERSION file to: $VERSION"
        echo ""
        echo "Would update version in:"
        for f in synchub/plugin.js \
                 agenthub/plugin.js \
                 habithub/plugin.js \
                 {{.COLLECTIONS_DIR}}/*/plugin.js \
                 {{.PLUGINS_DIR}}/*/plugin.js; do
          if [ -f "$f" ] && ! echo "$f" | grep -q "_template"; then
            echo "  - $f"
          fi
        done
        echo ""
        echo "Would create: thymer-synchub-$VERSION.zip"
        echo "Would commit, tag $VERSION, and push"
        echo "Would create GitHub release $VERSION"

  version:
    desc: Show current version
    cmds:
      - cat VERSION
